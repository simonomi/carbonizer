name: Build carbonizer

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-15
    steps:
    - name: Set up Swift
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2"
    - name: Checkout
      uses: actions/checkout@v4
    - name: Check Version
      run: grep -q "${{ github.ref_name }}" Sources/Carbonizer/Carbonizer.swift
    - name: Build
      run: >
        swift build -c release
        -Xswiftc -DIN_CI
    - name: Package
      run: tar -acf carbonizer-macOS.zip -C "$(swift build -c release --show-bin-path)" carbonizer
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        name: "Version ${{ github.ref_name }}"
        body: "\n\n\n## how to use\n\ndrag and drop an `.nds` file onto `carbonizer.exe` to unpack it, then drop the resulting folder back onto `carbonizer.exe` to repack it."
        files: carbonizer-macOS.zip

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
    - name: Set up Swift
      uses: compnerd/gha-setup-swift@main
      with:
        swift-version: swift-6.2-release
        swift-build: 6.2-RELEASE
    - name: Checkout
      uses: actions/checkout@v4
    - name: Check Version
      run: grep -q "${{ github.ref_name }}" Sources/Carbonizer/Carbonizer.swift
    - name: Build
      run: >
        swift build -c release
        -Xswiftc -DIN_CI
    - name: Download license
      run: curl -o LICENSE.txt "https://raw.githubusercontent.com/apple/swift/main/LICENSE.txt"
    - name: Package
      run: >
        tar -acf carbonizer-Windows.zip
        LICENSE.txt
        -C "$(swift build -c release --show-bin-path)"
        carbonizer.exe
        -C "$env:LOCALAPPDATA\\Programs\\Swift\\Runtimes\\6.2.0\\usr\\bin"
        swiftCore.dll swift_Concurrency.dll swiftWinSDK.dll swift_StringProcessing.dll swiftCRT.dll Foundation.dll swift_RegexParser.dll dispatch.dll BlocksRuntime.dll swiftDispatch.dll FoundationEssentials.dll FoundationInternationalization.dll _FoundationICU.dll swiftSynchronization.dll
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        name: "Version ${{ github.ref_name }}"
        body: "\n\n\n## how to use\n\ndrag and drop an `.nds` file onto `carbonizer.exe` to unpack it, then drop the resulting folder back onto `carbonizer.exe` to repack it."
        files: carbonizer-Windows.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
    - name: Set up Swift
      id: swift-setup
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2"
    - name: Checkout
      uses: actions/checkout@v4
    - name: Check Version
      run: grep -q "${{ github.ref_name }}" Sources/Carbonizer/Carbonizer.swift
    - name: Build
      run: >
        swift build -c release
        --static-swift-stdlib
        -Xswiftc -DIN_CI
    - name: Package
      run: tar -azcf carbonizer-linux-x86.zip -C "$(swift build -c release --show-bin-path)" carbonizer
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        name: "Version ${{ github.ref_name }}"
        body: "\n\n\n## how to use\n\ndrag and drop an `.nds` file onto `carbonizer.exe` to unpack it, then drop the resulting folder back onto `carbonizer.exe` to repack it."
        files: carbonizer-linux-x86.zip

  build-linux-arm:
    name: Build Linux ARM
    runs-on: ubuntu-24.04-arm
    steps:
    - name: Set up Swift
      id: swift-setup
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "6.2"
    - name: Checkout
      uses: actions/checkout@v4
    - name: Check Version
      run: grep -q "${{ github.ref_name }}" Sources/Carbonizer/Carbonizer.swift
    - name: Build
      run: >
        swift build -c release
        --static-swift-stdlib
        -Xswiftc -DIN_CI
    - name: Package
      run: tar -azcf carbonizer-linux-arm.zip -C "$(swift build -c release --show-bin-path)" carbonizer
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        name: "Version ${{ github.ref_name }}"
        body: "\n\n\n## how to use\n\ndrag and drop an `.nds` file onto `carbonizer.exe` to unpack it, then drop the resulting folder back onto `carbonizer.exe` to repack it."
        files: carbonizer-linux-arm.zip

