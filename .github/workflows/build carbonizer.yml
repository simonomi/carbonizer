name: Build carbonizer

on: 
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"
  
permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - name: Set up Swift
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "5.10"
    - name: Checkout
      uses: actions/checkout@v4
    - name: Test
      run: swift test -Xswiftc -DIN_CI
    - name: Build
      run: >
        swift build -c release
        -Xswiftc -DIN_CI
        -Xswiftc -whole-module-optimization
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        files: /Users/runner/work/carbonizer/carbonizer/.build/*/release/carbonizer
  
  build-windows:
    runs-on: windows-latest
    steps:
    - name: Set up Swift
      id: swift-setup
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: "5.10"
    # - name: Checkout
    #   uses: actions/checkout@v4
#     - name: Test
#       run: swift test -Xswiftc -DIN_CI
    # - name: Build
    #   run: >
    #     swift build -c release
    #     -Xswiftc -DIN_CI
    #     -Xswiftc -static-executable
    #     -Xswiftc -static-stdlib
    #     -Xswiftc -whole-module-optimization
    - run: dir "C:\\Users\\runneradmin\\AppData\\Local\\Programs\\Swift\\Runtimes\\5.10.0\\usr\\bin\\"
    - run: curl -o LICENSE.txt "https://raw.githubusercontent.com/apple/swift/main/LICENSE.txt"
    - run: echo "D:\\a\\carbonizer\\carbonizer\\.build\\*\\release\\carbonizer.exe"
    - run: dir "D:\\a\\carbonizer\\carbonizer\\.build\\*\\release\\carbonizer.exe"
    - run: echo "${{steps.swift-setup.outputs.swift-version}}"
    - run: >
        tar -acf thing.zip 
        "D:\\a\\carbonizer\\carbonizer\\.build\\*\\release\\carbonizer.exe"
        LICENSE.txt
        "C:\\Users\\runneradmin\\AppData\\Local\\Programs\\Swift\\Runtimes\\5.10.0\\usr\\bin\\swiftCore.dll"
        "C:\\Users\\runneradmin\\AppData\\Local\\Programs\\Swift\\Runtimes\\5.10.0\\usr\\bin\\swift_StringProcessing.dll"
        "C:\\Users\\runneradmin\\AppData\\Local\\Programs\\Swift\\Runtimes\\5.10.0\\usr\\bin\\swift_Concurrency.dll"
        "C:\\Users\\runneradmin\\AppData\\Local\\Programs\\Swift\\Runtimes\\5.10.0\\usr\\bin\\swiftWinSDK.dll"
    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        draft: true
        # files: D:/a/carbonizer/carbonizer/.build/*/release/carbonizer.exe
        files: thing.zip
